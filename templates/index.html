<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <style>
        :root {
    --primary-color: #10a37f;
    --secondary-color: #19c37d;
    --background-color: #f7f7f8;
    --sidebar-bg: #f9f9f9;
    --white: #ffffff;
    --text-primary: #374151;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --hover-color: #f3f4f6;
    --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
}

/* Dark theme variables */
[data-theme="dark"] {
    --background-color: #1a1a1a;
    --sidebar-bg: #2d2d2d;
    --white: #2d2d2d;
    --text-primary: #e5e5e5;
    --text-secondary: #a1a1a1;
    --border-color: #404040;
    --hover-color: #404040;
    --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--background-color);
    color: var(--text-primary);
    line-height: 1.6;
}

.app-container {
    display: flex;
    height: 100vh;
    overflow: hidden;
}

/* Sidebar */
.sidebar {
    width: 280px;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
}

.new-chat-btn {
    width: 100%;
    padding: 12px 16px;
    background-color: var(--primary-color);
    color: var(--white);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
}

.new-chat-btn:hover {
    background-color: var(--secondary-color);
    transform: translateY(-1px);
}

.chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

.chat-item {
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 4px;
}

.chat-item:hover {
    background-color: var(--hover-color);
}

.chat-item.active {
    background-color: var(--primary-color);
    color: var(--white);
}

.chat-title {
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 4px;
}

.chat-preview {
    font-size: 12px;
    opacity: 0.8;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-header {
    padding: 20px 24px;
    background-color: var(--white);
    border-bottom: 1px solid var(--border-color);
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
}

.header-left {
    /* Empty space for balance */
}

.header-center {
    display: flex;
    justify-content: center;
}

.header-right {
    display: flex;
    justify-content: flex-end;
}

.model-info {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    background-color: var(--background-color);
    padding: 8px 16px;
    border-radius: 8px;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}

.user-avatar:hover {
    background-color: #4b5563;
}

.user-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background-color: var(--white);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    min-width: 200px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 100;
}

.user-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.user-menu-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-menu-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
}

.user-menu-info h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 2px;
    color: #374151;
}

.user-menu-info p {
    font-size: 12px;
    color: #6b7280;
}

.user-menu-items {
    padding: 8px 0;
}

.user-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 14px;
    color: #374151;
}

.user-menu-item:hover {
    background-color: #f3f4f6;
}

.user-menu-item svg {
    width: 16px;
    height: 16px;
    color: #6b7280;
}

.theme-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.theme-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background-color: #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.theme-switch.active {
    background-color: var(--primary-color);
}

.theme-switch::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s ease;
}

.theme-switch.active::before {
    transform: translateX(20px);
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background-color: var(--white);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
}

.message {
    display: flex;
    margin-bottom: 32px;
    max-width: 800px;
}

.message.user {
    justify-content: flex-end;
    margin-left: auto;
    margin-right: 0;
}

.message.assistant {
    justify-content: flex-start;
    margin-left: 0;
    margin-right: auto;
}

.message.user .message-content {
    order: 1;
    margin-right: 16px;
    text-align: right;
}

.message.user .message-avatar {
    order: 2;
}

.message.assistant .message-content {
    order: 2;
    margin-left: 16px;
}

.message.assistant .message-avatar {
    order: 1;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    flex-shrink: 0;
}

.message.user .message-avatar {
    background-color: var(--text-primary);
}

.message-content {
    flex: 1;
}

.message-text {
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 8px;
}

.message-time {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Input Area */
.input-area {
    padding: 24px;
    background-color: var(--white);
    border-top: 1px solid var(--border-color);
    transition: opacity 0.3s ease;
    position: relative;
}

.input-area.centered {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: calc(100% - 280px - 48px);
    max-width: 600px;
    border: none;
    background: transparent;
    margin-left: 140px;
}

.input-area.centered::before {
    content: "How can I help you today?";
    display: block;
    text-align: center;
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 32px;
    color: var(--text-primary);
}

.input-area.disabled {
    /* Remove disabled state - allow input during generation */
}

.input-container {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    background-color: var(--white);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    box-shadow: var(--shadow);
}

#messageInput {
    width: 100%;
    border: none;
    outline: none;
    resize: none;
    font-size: 15px;
    line-height: 1.5;
    font-family: inherit;
    background: transparent;
    padding-right: 80px;
}

.input-actions {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 8px;
}

.tool-btn, .send-btn, .pause-btn, .stop-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.tool-btn {
    background-color: var(--background-color);
    color: var(--text-secondary);
}

.tool-btn:hover {
    background-color: var(--hover-color);
    color: var(--text-primary);
}

.tool-btn.active {
    background-color: var(--primary-color);
    color: var(--white);
}

.send-btn {
    background-color: var(--primary-color);
    color: var(--white);
}

.send-btn:hover {
    background-color: var(--secondary-color);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pause-btn {
    background-color: #f59e0b;
    color: var(--white);
}

.pause-btn:hover {
    background-color: #d97706;
}

.pause-btn.paused {
    background-color: var(--primary-color);
}

.pause-btn.paused:hover {
    background-color: var(--secondary-color);
}

.stop-btn {
    background-color: #ef4444;
    color: var(--white);
}

.stop-btn:hover {
    background-color: #dc2626;
}

.selected-tools {
    margin-top: 12px;
    margin-left: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-width: 800px;
    margin: 12px auto 0;
}

.tool-tag {
    background-color: var(--primary-color);
    color: var(--white);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.tool-tag button {
    background: none;
    border: none;
    color: var(--white);
    cursor: pointer;
    padding: 0;
    margin-left: 4px;
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background-color: var(--white);
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal-overlay.active .modal-content {
    transform: scale(1);
}

.modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 600;
}

.close-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: var(--text-secondary);
    border-radius: 4px;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background-color: var(--hover-color);
    color: var(--text-primary);
}

.modal-body {
    padding: 24px;
}

.tool-category {
    margin-bottom: 24px;
}

.tool-category h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-secondary);
}

.tool-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.tool-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tool-option:hover {
    background-color: var(--hover-color);
}

.tool-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color);
}

.tool-info {
    flex: 1;
}

.tool-name {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 2px;
}

.tool-description {
    font-size: 12px;
    color: var(--text-secondary);
}

.modal-footer {
    padding: 16px 24px 24px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.btn-secondary, .btn-primary {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-secondary {
    background-color: var(--background-color);
    color: var(--text-primary);
}

.btn-secondary:hover {
    background-color: var(--hover-color);
}

.btn-primary {
    background-color: var(--primary-color);
    color: var(--white);
}

.btn-primary:hover {
    background-color: var(--secondary-color);
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        width: 260px;
    }
    
    .chat-container {
        padding: 16px;
    }
    
    .input-area {
        padding: 16px;
    }
    
    .modal-content {
        width: 95%;
        margin: 20px;
    }
    
    .selected-tools {
        margin-left: 16px;
    }
}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    New Chat
                </button>
            </div>
            <div class="chat-history" id="chatHistory">
                <div class="chat-item active" data-chat-id="1">
                    <div class="chat-title">Welcome Chat</div>
                    <div class="chat-preview">How can I help you today?</div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div class="chat-header">
                <div class="header-left"></div>
                <div class="header-center">
                    <div class="model-info">GPT-4 Turbo</div>
                </div>
                <div class="header-right">
                    <div class="user-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <div class="user-menu" id="userMenu">
                            <div class="user-menu-header">
                                <div class="user-menu-avatar">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                </div>
                                <div class="user-menu-info">
                                    <h4>User</h4>
                                    <p>user@example.com</p>
                                </div>
                            </div>
                            <div class="user-menu-items">
                                <div class="user-menu-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                    Profile Settings
                                </div>
                                <div class="user-menu-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                                    </svg>
                                    <div class="theme-toggle">
                                        <span>Dark Mode</span>
                                        <div class="theme-switch" id="themeSwitch"></div>
                                    </div>
                                </div>
                                <div class="user-menu-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                        <polyline points="16,17 21,12 16,7"/>
                                        <line x1="21" y1="12" x2="9" y2="12"/>
                                    </svg>
                                    Sign Out
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="Message AI Assistant..." 
                        rows="1"
                    ></textarea>
                    <div class="input-actions">
                        <button class="tool-btn" id="toolBtn" title="Select Tools">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                            </svg>
                        </button>
                        <button class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                        <button class="pause-btn" id="pauseBtn" style="display: none;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="4" width="4" height="16"/>
                                <rect x="14" y="4" width="4" height="16"/>
                            </svg>
                        </button>
                        <button class="stop-btn" id="stopBtn" style="display: none;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="selected-tools" id="selectedTools"></div>
            </div>
        </div>
    </div>

    <!-- Tool Selection Modal -->
    <div class="modal-overlay" id="toolModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Tools</h3>
                <button class="close-btn" id="closeModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tools will be dynamically loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="clearTools">Clear All</button>
                <button class="btn-primary" id="applyTools">Apply</button>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
    constructor() {
        // Determine API base URL (use localhost server when opened via file://)
        this.apiURL = window.location.protocol === 'file:'
            ? 'http://localhost:5000'
            : window.location.origin;
        this.chats = [];
        this.currentChatId = 1;
        this.selectedTools = new Set();
        this.messageId = 0;
        this.isGenerating = false;
        this.isPaused = false;
        this.generationTimeout = null;
        this.isNewChat = true;
        
        this.initializeElements();
        this.attachEventListeners();
        
        // Load available tools from backend on startup
        this.loadAvailableTools();
        this.setupAutoResize();
    }
    
    initializeElements() {
        this.chatContainer = document.getElementById('chatContainer');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.toolBtn = document.getElementById('toolBtn');
        this.toolModal = document.getElementById('toolModal');
        this.newChatBtn = document.getElementById('newChatBtn');
        this.chatHistory = document.getElementById('chatHistory');
        this.selectedToolsContainer = document.getElementById('selectedTools');
        this.closeModal = document.getElementById('closeModal');
        this.applyTools = document.getElementById('applyTools');
        this.clearTools = document.getElementById('clearTools');
        
        // New elements
        this.pauseBtn = document.getElementById('pauseBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.inputArea = document.querySelector('.input-area');
        this.userAvatar = document.querySelector('.user-avatar');
        this.userMenu = document.getElementById('userMenu');
        
        // Theme toggle
        this.themeSwitch = document.getElementById('themeSwitch');
        
        // Prevent menu from closing when clicking theme toggle
        const themeToggleItem = document.querySelector('.user-menu-item .theme-toggle');
        if (themeToggleItem) {
            themeToggleItem.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Initialize with centered input for new chat
        this.inputArea.classList.add('centered');
        
        // Initialize theme
        this.initializeTheme();
    }
    
    attachEventListeners() {
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        
        this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        this.toolBtn.addEventListener('click', () => this.openToolModal());
        this.closeModal.addEventListener('click', () => this.closeToolModal());
        this.toolModal.addEventListener('click', (e) => {
            if (e.target === this.toolModal) {
                this.closeToolModal();
            }
        });
        
        this.applyTools.addEventListener('click', () => this.applySelectedTools());
        this.clearTools.addEventListener('click', () => this.clearSelectedTools());
        
        this.newChatBtn.addEventListener('click', () => this.createNewChat());
        
        // Generation control buttons
        this.pauseBtn.addEventListener('click', () => this.pauseGeneration());
        this.stopBtn.addEventListener('click', () => this.stopGeneration());
        
        // User menu
        this.userAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleUserMenu();
        });
        
        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!this.userAvatar.contains(e.target)) {
                this.userMenu.classList.remove('active');
            }
        });
        
        // Tool selection listeners
        const toolCheckboxes = document.querySelectorAll('input[type="checkbox"][data-tool]');
        toolCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => this.updateToolSelection());
        });
    }
    
    toggleUserMenu() {
        this.userMenu.classList.toggle('active');
    }
    
    setupAutoResize() {
        this.messageInput.addEventListener('input', () => {
            this.messageInput.style.height = 'auto';
            this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
        });
    }

    // Theme initialization: apply saved theme and set up toggle listener
    initializeTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            this.themeSwitch.classList.add('active');
        } else {
            document.documentElement.removeAttribute('data-theme');
            this.themeSwitch.classList.remove('active');
        }
        this.themeSwitch.addEventListener('click', () => {
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                document.documentElement.removeAttribute('data-theme');
                this.themeSwitch.classList.remove('active');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                this.themeSwitch.classList.add('active');
                localStorage.setItem('theme', 'dark');
            }
        });
    }
    
    // Fetch available tools from the backend and render in modal
    loadAvailableTools() {
        fetch(`${this.apiURL}/tools`)
            .then(res => res.json())
            .then(data => {
                this.availableTools = data.tools || [];
                this.renderToolOptions();
            })
            .catch(err => console.error('Failed to load tools', err));
    }

    // Render dynamic tool selection options
    renderToolOptions() {
        const modalBody = this.toolModal.querySelector('.modal-body');
        modalBody.innerHTML = `
            <div class="tool-category">
                <h4>Available Tools</h4>
                <div class="tool-list" id="dynamicToolList"></div>
            </div>
        `;
        const toolList = modalBody.querySelector('#dynamicToolList');
        this.availableTools.forEach(tool => {
            const label = document.createElement('label');
            label.className = 'tool-option';
            label.innerHTML = `
                <input type="checkbox" data-tool="${tool.name}">
                <div class="tool-info">
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-description">${tool.description}</div>
                </div>
            `;
            toolList.appendChild(label);
        });
        // Re-attach checkbox listeners
        const toolCheckboxes = modalBody.querySelectorAll('input[type="checkbox"][data-tool]');
        toolCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => this.updateToolSelection());
        });
    }

    sendMessage() {
        if (this.isGenerating) return;
        
        const message = this.messageInput.value.trim();
        if (!message) return;
        
        // Move input to bottom if this is the first message
        if (this.isNewChat) {
            this.inputArea.classList.remove('centered');
            this.isNewChat = false;
        }
        
        this.addMessage(message, 'user');
        this.messageInput.value = '';
        this.messageInput.style.height = 'auto';
        
        this.startGeneration();
        // Call backend chat endpoint
        fetch(`${this.apiURL}/chat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: message,
                selected_tools: Array.from(this.selectedTools)
            })
        })
        .then(res => res.json())
        .then(data => {
            this.stopGeneration();
            // Display AI response
            this.addMessage(data.ai_response, 'assistant');
            // Display tool execution results
            if (data.tools && data.tools.length > 0) {
                data.tools.forEach(tool => {
                    const content = tool.success ?
                        `✅ ${tool.name} executed successfully: ${tool.result}` :
                        `❌ ${tool.name} failed: ${tool.error}`;
                    this.addMessage(content, 'assistant');
                });
            }
        })
        .catch(err => {
            this.stopGeneration();
            this.addMessage(`Error: ${err.toString()}`, 'assistant');
        });
    }
    
    startGeneration() {
        this.isGenerating = true;
        this.isPaused = false;
        
        // Hide send button, show pause and stop buttons
        this.sendBtn.style.display = 'none';
        this.pauseBtn.style.display = 'flex';
        this.stopBtn.style.display = 'flex';
    }
    
    pauseGeneration() {
        if (this.isPaused) {
            // Resume
            this.isPaused = false;
            this.pauseBtn.classList.remove('paused');
            this.pauseBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            `;
        } else {
            // Pause
            this.isPaused = true;
            this.pauseBtn.classList.add('paused');
            this.pauseBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5,3 19,12 5,21"/>
                </svg>
            `;
            
            if (this.generationTimeout) {
                clearTimeout(this.generationTimeout);
                this.generationTimeout = null;
            }
        }
    }
    
    stopGeneration() {
        this.isGenerating = false;
        this.isPaused = false;
        
        if (this.generationTimeout) {
            clearTimeout(this.generationTimeout);
            this.generationTimeout = null;
        }
        
        // Show send button, hide pause and stop buttons
        this.sendBtn.style.display = 'flex';
        this.pauseBtn.style.display = 'none';
        this.stopBtn.style.display = 'none';
        this.pauseBtn.classList.remove('paused');
        
        // Reset pause button icon
        this.pauseBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
        `;
    }
    
    addMessage(content, sender) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = sender === 'user' ? 
            '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' :
            '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>';
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        messageText.textContent = content;
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = this.formatTime(new Date());
        
        messageContent.appendChild(messageText);
        messageContent.appendChild(messageTime);
        
        messageElement.appendChild(avatar);
        messageElement.appendChild(messageContent);
        
        this.chatContainer.appendChild(messageElement);
        this.scrollToBottom();
    }
    
    simulateAIResponse(userMessage) {
        let response = "I understand you're asking about: \"" + userMessage + "\". ";
        
        if (this.selectedTools.size > 0) {
            response += "I'll use the following tools to help you: " + 
                       Array.from(this.selectedTools).map(tool => 
                           tool.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())
                       ).join(', ') + ". ";
        }
        
        response += "This is a demo response. In a real implementation, this would be connected to an AI service that would process your request and provide a meaningful response.";
        
        this.addMessage(response, 'assistant');
    }
    
    openToolModal() {
        this.toolModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    closeToolModal() {
        this.toolModal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    updateToolSelection() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][data-tool]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        
        if (selectedCount > 0) {
            this.toolBtn.classList.add('active');
        } else {
            this.toolBtn.classList.remove('active');
        }
    }
    
    applySelectedTools() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][data-tool]');
        this.selectedTools.clear();
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                this.selectedTools.add(checkbox.dataset.tool);
            }
        });
        
        this.updateSelectedToolsDisplay();
        this.closeToolModal();
    }
    
    clearSelectedTools() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][data-tool]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        this.selectedTools.clear();
        this.updateSelectedToolsDisplay();
        this.toolBtn.classList.remove('active');
    }
    
    updateSelectedToolsDisplay() {
        this.selectedToolsContainer.innerHTML = '';
        
        this.selectedTools.forEach(tool => {
            const toolTag = document.createElement('div');
            toolTag.className = 'tool-tag';
            toolTag.innerHTML = `
                ${tool.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                <button onclick="chatApp.removeSelectedTool('${tool}')">×</button>
            `;
            this.selectedToolsContainer.appendChild(toolTag);
        });
    }
    
    removeSelectedTool(tool) {
        this.selectedTools.delete(tool);
        
        // Update checkbox state
        const checkbox = document.querySelector(`input[data-tool="${tool}"]`);
        if (checkbox) {
            checkbox.checked = false;
        }
        
        this.updateSelectedToolsDisplay();
        this.updateToolSelection();
    }
    
    createNewChat() {
        this.currentChatId++;
        this.isNewChat = true;
        
        // Stop any ongoing generation
        this.stopGeneration();
        
        // Add new chat to history
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.dataset.chatId = this.currentChatId;
        chatItem.innerHTML = `
            <div class="chat-title">New Chat ${this.currentChatId}</div>
            <div class="chat-preview">Start a new conversation</div>
        `;
        
        // Remove active class from other chats
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        chatItem.classList.add('active');
        this.chatHistory.insertBefore(chatItem, this.chatHistory.firstChild);
        
        // Clear current chat and show centered input
        this.clearChat();
        this.inputArea.classList.add('centered');
        
        // Add click listener
        chatItem.addEventListener('click', () => this.switchChat(this.currentChatId));
    }
    
    switchChat(chatId) {
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (chatItem) {
            chatItem.classList.add('active');
        }
        
        this.currentChatId = chatId;
        this.isNewChat = true;
        this.clearChat();
        this.inputArea.classList.add('centered');
        this.stopGeneration();
    }
    
    clearChat() {
        this.chatContainer.innerHTML = '';
    }
    
    scrollToBottom() {
        this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    }
    
    formatTime(date) {
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.chatApp = new ChatApp();
});
    </script>
</body>
</html>
